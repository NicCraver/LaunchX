name: Build and Release

on:
    push:
        tags:
            - "v*"

permissions:
    contents: write

jobs:
    build:
        runs-on: macos-26

        steps:
            - name: Checkout code
              uses: actions/checkout@v4

            - name: Setup Xcode
              uses: maxim-lobanov/setup-xcode@v1
              with:
                  xcode-version: latest-stable

            - name: Set version
              run: |
                  VERSION=$(echo "${{ github.ref_name }}" | sed 's/^v//')
                  BUILD_NUMBER="${{ github.run_number }}"

                  # Update MARKETING_VERSION in project.pbxproj
                  sed -i '' "s/MARKETING_VERSION = [^;]*;/MARKETING_VERSION = $VERSION;/g" LaunchX.xcodeproj/project.pbxproj

                  # Update CURRENT_PROJECT_VERSION in project.pbxproj
                  sed -i '' "s/CURRENT_PROJECT_VERSION = [^;]*;/CURRENT_PROJECT_VERSION = $BUILD_NUMBER;/g" LaunchX.xcodeproj/project.pbxproj

                  echo "Updated version to $VERSION (build $BUILD_NUMBER)"

            - name: Build app (Apple Silicon)
              run: |
                  xcodebuild -scheme LaunchX \
                    -configuration Release \
                    -arch arm64 \
                    -archivePath $PWD/build/LaunchX-arm64.xcarchive \
                    archive \
                    ONLY_ACTIVE_ARCH=NO \
                    CODE_SIGN_IDENTITY="-" \
                    CODE_SIGNING_REQUIRED=NO \
                    CODE_SIGNING_ALLOWED=NO

            - name: Build app (Intel)
              run: |
                  xcodebuild -scheme LaunchX \
                    -configuration Release \
                    -arch x86_64 \
                    -archivePath $PWD/build/LaunchX-x86_64.xcarchive \
                    archive \
                    ONLY_ACTIVE_ARCH=NO \
                    CODE_SIGN_IDENTITY="-" \
                    CODE_SIGNING_REQUIRED=NO \
                    CODE_SIGNING_ALLOWED=NO

            - name: Export apps
              run: |
                  # Export Apple Silicon app
                  mkdir -p build/export-arm64
                  cp -R build/LaunchX-arm64.xcarchive/Products/Applications/LaunchX.app build/export-arm64/
                  cp Repair build/export-arm64/

                  # Export Intel app
                  mkdir -p build/export-x86_64
                  cp -R build/LaunchX-x86_64.xcarchive/Products/Applications/LaunchX.app build/export-x86_64/
                  cp Repair build/export-x86_64/

            - name: Install create-dmg
              run: brew install create-dmg

            - name: Create DMG (Apple Silicon)
              run: |
                  create-dmg \
                    --volname "LaunchX" \
                    --window-pos 200 120 \
                    --window-size 600 400 \
                    --icon-size 100 \
                    --icon "LaunchX.app" 150 185 \
                    --hide-extension "LaunchX.app" \
                    --app-drop-link 450 185 \
                    "build/LaunchX-${{ github.ref_name }}-arm64.dmg" \
                    "build/export-arm64/" || true

                  # Fallback: create simple DMG if create-dmg fails
                  if [ ! -f "build/LaunchX-${{ github.ref_name }}-arm64.dmg" ]; then
                    hdiutil create -volname "LaunchX" -srcfolder "build/export-arm64" -ov -format UDZO "build/LaunchX-${{ github.ref_name }}-arm64.dmg"
                  fi

            - name: Create DMG (Intel)
              run: |
                  create-dmg \
                    --volname "LaunchX" \
                    --window-pos 200 120 \
                    --window-size 600 400 \
                    --icon-size 100 \
                    --icon "LaunchX.app" 150 185 \
                    --hide-extension "LaunchX.app" \
                    --app-drop-link 450 185 \
                    "build/LaunchX-${{ github.ref_name }}-x86_64.dmg" \
                    "build/export-x86_64/" || true

                  # Fallback: create simple DMG if create-dmg fails
                  if [ ! -f "build/LaunchX-${{ github.ref_name }}-x86_64.dmg" ]; then
                    hdiutil create -volname "LaunchX" -srcfolder "build/export-x86_64" -ov -format UDZO "build/LaunchX-${{ github.ref_name }}-x86_64.dmg"
                  fi

            - name: Create ZIPs
              run: |
                  cd build/export-arm64
                  zip -r ../LaunchX-${{ github.ref_name }}-arm64.zip LaunchX.app
                  cd ../export-x86_64
                  zip -r ../LaunchX-${{ github.ref_name }}-x86_64.zip LaunchX.app

            - name: Generate release notes
              id: release_notes
              run: |
                  VERSION="${{ github.ref_name }}"
                  CHANGELOG=""

                  # 尝试从 CHANGELOG.md 提取当前版本的更新内容
                  if [ -f "CHANGELOG.md" ]; then
                    # 提取当前版本的更新日志（从 ## vX.X.X 到下一个 ## v 之间的内容）
                    CHANGELOG=$(sed -n "/^## ${VERSION}/,/^## v/p" CHANGELOG.md | sed '$d')
                  fi

                  echo "notes<<EOF" >> $GITHUB_OUTPUT

                  # 如果有 CHANGELOG 内容则使用，否则使用默认标题
                  if [ -n "$CHANGELOG" ]; then
                    echo "$CHANGELOG" >> $GITHUB_OUTPUT
                  else
                    echo "## LaunchX ${VERSION}" >> $GITHUB_OUTPUT
                  fi

                  echo "" >> $GITHUB_OUTPUT
                  echo "### Downloads" >> $GITHUB_OUTPUT
                  echo "- **Apple Silicon (M1/M2/M3)**: LaunchX-${VERSION}-arm64.dmg" >> $GITHUB_OUTPUT
                  echo "- **Intel**: LaunchX-${VERSION}-x86_64.dmg" >> $GITHUB_OUTPUT

                  echo "EOF" >> $GITHUB_OUTPUT

            - name: Create Release
              uses: softprops/action-gh-release@v1
              with:
                  name: LaunchX ${{ github.ref_name }}
                  body: ${{ steps.release_notes.outputs.notes }}
                  draft: false
                  prerelease: ${{ contains(github.ref_name, 'alpha') || contains(github.ref_name, 'beta') }}
                  files: |
                      build/LaunchX-${{ github.ref_name }}-arm64.dmg
                      build/LaunchX-${{ github.ref_name }}-arm64.zip
                      build/LaunchX-${{ github.ref_name }}-x86_64.dmg
                      build/LaunchX-${{ github.ref_name }}-x86_64.zip
              env:
                  GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

            - name: Update Appcast
              env:
                  SPARKLE_PRIVATE_KEY: ${{ secrets.SPARKLE_PRIVATE_KEY }}
              run: |
                  VERSION="${{ github.ref_name }}"
                  DMG_PATH="build/LaunchX-${VERSION}-arm64.dmg"

                  # 检查 DMG 是否存在
                  if [ ! -f "$DMG_PATH" ]; then
                    echo "Error: DMG file not found at $DMG_PATH"
                    ls -R build/
                    exit 1
                  fi

                  # 下载 Sparkle 工具以获取 sign_update
                  curl -L -o Sparkle.tar.xz https://github.com/sparkle-project/Sparkle/releases/download/2.6.4/Sparkle-2.6.4.tar.xz
                  tar -xf Sparkle.tar.xz bin/sign_update
                  chmod +x bin/sign_update

                  SIGN_ATTRIBUTES=""
                  if [ -n "$SPARKLE_PRIVATE_KEY" ]; then
                    # sign_update 会输出类似 sparkle:edSignature="..." length="..." 的字符串
                    # 使用 env 命令传递环境变量，避免 shell 导出问题
                    SIGN_ATTRIBUTES=$(SUPrivateEDKey="${SPARKLE_PRIVATE_KEY}" ./bin/sign_update "$DMG_PATH")
                    if [ $? -ne 0 ]; then
                      echo "Error: sign_update failed"
                      exit 1
                    fi
                  else
                    echo "Warning: SPARKLE_PRIVATE_KEY is not set. Update will not be signed correctly."
                    FILE_SIZE=$(stat -f%z "$DMG_PATH")
                    SIGN_ATTRIBUTES="length=\"$FILE_SIZE\""
                  fi

                  cat <<EOF > appcast.xml
                  <?xml version="1.0" standalone="yes"?>
                  <rss xmlns:sparkle="http://www.andymatuschak.org/xml-namespaces/sparkle" version="2.0">
                      <channel>
                          <title>LaunchX</title>
                          <item>
                              <title>Version ${VERSION}</title>
                              <sparkle:releaseNotesLink>https://github.com/twotwoba/LaunchX/releases/tag/${VERSION}</sparkle:releaseNotesLink>
                              <pubDate>$(date -u +"%a, %d %b %Y %H:%M:%S %z")</pubDate>
                              <sparkle:version>${{ github.run_number }}</sparkle:version>
                              <sparkle:shortVersionString>${VERSION#v}</sparkle:shortVersionString>
                              <enclosure
                                  url="https://github.com/twotwoba/LaunchX/releases/download/${VERSION}/LaunchX-${VERSION}-arm64.dmg"
                                  sparkle:os="macos"
                                  sparkle:version="${{ github.run_number }}"
                                  $SIGN_ATTRIBUTES
                                  type="application/octet-stream" />
                          </item>
                      </channel>
                  </rss>
                  EOF

            - name: Commit and Push Version Changes
              run: |
                  VERSION="${{ github.ref_name }}"

                  git config --local user.email "github-actions[bot]@users.noreply.github.com"
                  git config --local user.name "github-actions[bot]"

                  # Checkout main branch (we're currently in detached HEAD state from the tag)
                  git fetch origin main
                  git checkout main
                  git pull origin main

                  # Add appcast and the project file with updated version
                  git add appcast.xml
                  git add LaunchX.xcodeproj/project.pbxproj || echo "Project file not found"

                  # Check if there are changes to commit
                  if git diff --staged --quiet; then
                    echo "No changes to commit"
                  else
                    git commit -m "chore: bump version to ${VERSION} and update appcast"
                    git push origin main
                  fi
