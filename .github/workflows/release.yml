name: Build and Release

on:
    push:
        tags:
            - "v*"

permissions:
    contents: write

jobs:
    build:
        runs-on: macos-26

        steps:
            - name: Checkout code
              uses: actions/checkout@v4

            - name: Setup Xcode
              uses: maxim-lobanov/setup-xcode@v1
              with:
                  xcode-version: latest-stable

            - name: Build app (Apple Silicon)
              run: |
                  xcodebuild -scheme LaunchX \
                    -configuration Release \
                    -arch arm64 \
                    -archivePath $PWD/build/LaunchX-arm64.xcarchive \
                    archive \
                    ONLY_ACTIVE_ARCH=NO \
                    CODE_SIGN_IDENTITY="-" \
                    CODE_SIGNING_REQUIRED=NO \
                    CODE_SIGNING_ALLOWED=NO

            - name: Build app (Intel)
              run: |
                  xcodebuild -scheme LaunchX \
                    -configuration Release \
                    -arch x86_64 \
                    -archivePath $PWD/build/LaunchX-x86_64.xcarchive \
                    archive \
                    ONLY_ACTIVE_ARCH=NO \
                    CODE_SIGN_IDENTITY="-" \
                    CODE_SIGNING_REQUIRED=NO \
                    CODE_SIGNING_ALLOWED=NO

            - name: Export apps
              run: |
                  # Export Apple Silicon app
                  mkdir -p build/export-arm64
                  cp -R build/LaunchX-arm64.xcarchive/Products/Applications/LaunchX.app build/export-arm64/
                  cp repair.sh build/export-arm64/

                  # Export Intel app
                  mkdir -p build/export-x86_64
                  cp -R build/LaunchX-x86_64.xcarchive/Products/Applications/LaunchX.app build/export-x86_64/
                  cp repair.sh build/export-x86_64/

            - name: Install create-dmg
              run: brew install create-dmg

            - name: Create DMG (Apple Silicon)
              run: |
                  create-dmg \
                    --volname "LaunchX" \
                    --window-pos 200 120 \
                    --window-size 600 400 \
                    --icon-size 100 \
                    --icon "LaunchX.app" 150 185 \
                    --hide-extension "LaunchX.app" \
                    --app-drop-link 450 185 \
                    "build/LaunchX-${{ github.ref_name }}-arm64.dmg" \
                    "build/export-arm64/" || true

                  # Fallback: create simple DMG if create-dmg fails
                  if [ ! -f "build/LaunchX-${{ github.ref_name }}-arm64.dmg" ]; then
                    hdiutil create -volname "LaunchX" -srcfolder "build/export-arm64" -ov -format UDZO "build/LaunchX-${{ github.ref_name }}-arm64.dmg"
                  fi

            - name: Create DMG (Intel)
              run: |
                  create-dmg \
                    --volname "LaunchX" \
                    --window-pos 200 120 \
                    --window-size 600 400 \
                    --icon-size 100 \
                    --icon "LaunchX.app" 150 185 \
                    --hide-extension "LaunchX.app" \
                    --app-drop-link 450 185 \
                    "build/LaunchX-${{ github.ref_name }}-x86_64.dmg" \
                    "build/export-x86_64/" || true

                  # Fallback: create simple DMG if create-dmg fails
                  if [ ! -f "build/LaunchX-${{ github.ref_name }}-x86_64.dmg" ]; then
                    hdiutil create -volname "LaunchX" -srcfolder "build/export-x86_64" -ov -format UDZO "build/LaunchX-${{ github.ref_name }}-x86_64.dmg"
                  fi

            - name: Create ZIPs
              run: |
                  cd build/export-arm64
                  zip -r ../LaunchX-${{ github.ref_name }}-arm64.zip LaunchX.app
                  cd ../export-x86_64
                  zip -r ../LaunchX-${{ github.ref_name }}-x86_64.zip LaunchX.app

            - name: Generate release notes
              id: release_notes
              run: |
                  VERSION="${{ github.ref_name }}"
                  CHANGELOG=""

                  # 尝试从 CHANGELOG.md 提取当前版本的更新内容
                  if [ -f "CHANGELOG.md" ]; then
                    # 提取当前版本的更新日志（从 ## vX.X.X 到下一个 ## v 之间的内容）
                    CHANGELOG=$(sed -n "/^## ${VERSION}/,/^## v/p" CHANGELOG.md | sed '$d')
                  fi

                  echo "notes<<EOF" >> $GITHUB_OUTPUT

                  # 如果有 CHANGELOG 内容则使用，否则使用默认标题
                  if [ -n "$CHANGELOG" ]; then
                    echo "$CHANGELOG" >> $GITHUB_OUTPUT
                  else
                    echo "## LaunchX ${VERSION}" >> $GITHUB_OUTPUT
                  fi

                  echo "" >> $GITHUB_OUTPUT
                  echo "### Downloads" >> $GITHUB_OUTPUT
                  echo "- **Apple Silicon (M1/M2/M3)**: LaunchX-${VERSION}-arm64.dmg" >> $GITHUB_OUTPUT
                  echo "- **Intel**: LaunchX-${VERSION}-x86_64.dmg" >> $GITHUB_OUTPUT

                  echo "EOF" >> $GITHUB_OUTPUT

            - name: Create Release
              uses: softprops/action-gh-release@v1
              with:
                  name: LaunchX ${{ github.ref_name }}
                  body: ${{ steps.release_notes.outputs.notes }}
                  draft: false
                  prerelease: ${{ contains(github.ref_name, 'alpha') || contains(github.ref_name, 'beta') }}
                  files: |
                      build/LaunchX-${{ github.ref_name }}-arm64.dmg
                      build/LaunchX-${{ github.ref_name }}-arm64.zip
                      build/LaunchX-${{ github.ref_name }}-x86_64.dmg
                      build/LaunchX-${{ github.ref_name }}-x86_64.zip
              env:
                  GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
